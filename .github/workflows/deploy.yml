name: .NET API Deployment Pipeline

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  DOCKERFILE_PATH: Dockerfile
  SSH_PORT: 22
  CONTAINER_PORT: 44315
  HOST_PORT: 55501
  DEPLOY_DIR: /root/bebochka-backend
  IMAGE_NAME: bebochka-backend

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - name: Validate SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
        echo "SSH key validated successfully"
      env:
        SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

  test-connection:
    needs: validate
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || success() }}
    steps:
    - name: Test SSH connection
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SSH_HOST }}
        port: ${{ env.SSH_PORT }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== SSH Connection Test ==="
          echo "Connection successful!"
          echo "Docker version: $(docker --version)"
          echo "Disk space: $(df -h)"
          echo "Existing containers:"
          docker ps -a
          echo "=== Test completed successfully ==="

  test:
    needs: validate
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: |
        dotnet restore
        
    - name: Build project
      run: |
        dotnet build --configuration Release --no-restore
        
    - name: Run unit tests (if available)
      run: |
        if [ -d "Tests" ] || [ -f "*.Tests.csproj" ]; then
          dotnet test --configuration Release --verbosity normal --no-build
        else
          echo "No test projects found, skipping tests"
        fi
      continue-on-error: true

  build:
    needs: [validate, test]
    runs-on: ubuntu-latest
    outputs:
      docker_tag: ${{ steps.determine_tag.outputs.TAG }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Determine Docker tag
      id: determine_tag
      run: |
        if [ -n "$(git tag --points-at HEAD)" ]; then
          echo "TAG=$(git tag --points-at HEAD)" >> $GITHUB_OUTPUT
        else
          echo "TAG=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT
        fi
        echo "Using tag: $TAG"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker buildx create --use
        docker buildx build \
          -f ${{ env.DOCKERFILE_PATH }} \
          -t ${{ env.IMAGE_NAME }}:${{ steps.determine_tag.outputs.TAG }} \
          -t ${{ env.IMAGE_NAME }}:latest \
          --platform linux/amd64 \
          --load \
          .

    - name: Save Docker image
      run: |
        docker save ${{ env.IMAGE_NAME }}:latest | gzip > ${{ env.IMAGE_NAME }}.tar.gz

    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: ${{ env.IMAGE_NAME }}.tar.gz
        retention-days: 1

  deploy:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Download Docker image artifact
      uses: actions/download-artifact@v4
      with:
        name: docker-image
        path: .

    - name: Prepare deployment directory
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ env.SSH_PORT }}
        script: |
          mkdir -p ${{ env.DEPLOY_DIR }}/uploads
          mkdir -p ${{ env.DEPLOY_DIR }}/logs
          chmod 777 ${{ env.DEPLOY_DIR }}/uploads
          echo "Uploads directory created with permissions: $(ls -ld ${{ env.DEPLOY_DIR }}/uploads)"

    - name: Verify Docker image exists
      run: |
        echo "Checking Docker image..."
        ls -lh ${{ env.IMAGE_NAME }}.tar.gz || exit 1
        test -f ${{ env.IMAGE_NAME }}.tar.gz || exit 1
        echo "✅ Docker image exists"
        
    - name: Copy Docker image to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ env.SSH_PORT }}
        source: "${{ env.IMAGE_NAME }}.tar.gz"
        target: "/tmp"
        overwrite: true

    - name: Verify files exist before copying
      run: |
        echo "Checking files to copy..."
        ls -la docker-compose.yml Dockerfile || exit 1
        test -f docker-compose.yml || exit 1
        test -f Dockerfile || exit 1
        echo "✅ All files exist"
        
    - name: Copy docker-compose.yml and Dockerfile to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ env.SSH_PORT }}
        source: "docker-compose.yml,Dockerfile"
        target: "${{ env.DEPLOY_DIR }}"
        overwrite: true

    - name: Create .env file on server
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ env.SSH_PORT }}
        script: |
          #!/bin/bash
          set -euo pipefail
          
          # Create .env file with secrets
          cat > ${{ env.DEPLOY_DIR }}/.env << EOF
          DB_CONNECTION_STRING=${{ secrets.DB_CONNECTION_STRING }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_BOT_CHANNEL_ID=${{ secrets.TELEGRAM_BOT_CHANNEL_ID }}
          EOF
          
          # Secure .env file
          chmod 600 ${{ env.DEPLOY_DIR }}/.env
          echo ".env file created successfully"
          echo "Verifying .env file..."
          if [ -f ${{ env.DEPLOY_DIR }}/.env ]; then
            echo "✅ .env file created"
            grep -q "TELEGRAM_BOT_CHANNEL_ID" ${{ env.DEPLOY_DIR }}/.env && echo "✅ TELEGRAM_BOT_CHANNEL_ID found in .env" || echo "⚠️ TELEGRAM_BOT_CHANNEL_ID not found"
          else
            echo "❌ .env file not created"
            exit 1
          fi

    - name: Deploy application
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ env.SSH_PORT }}
        envs: IMAGE_NAME,DEPLOY_DIR
        script: |
          #!/bin/bash
          set -euo pipefail

          # Load Docker image
          echo "Loading Docker image..."
          docker load < /tmp/$IMAGE_NAME.tar.gz
          rm /tmp/$IMAGE_NAME.tar.gz

          cd $DEPLOY_DIR
          
          # Stop and remove old containers (force remove if needed)
          docker-compose down || true
          
          # Force remove container by name if it still exists (from old docker run)
          docker stop $IMAGE_NAME || true
          docker rm -f $IMAGE_NAME || true

          # Ensure uploads directory has correct permissions
          mkdir -p wwwroot/uploads
          chmod -R 777 wwwroot/uploads || true
          
          # Start new containers using docker-compose (use already loaded image)
          docker-compose up -d
          
          # Wait a bit for container to start
          sleep 3
          
          # Check container status
          echo "Checking container status:"
          docker-compose ps
          
          # Check container logs
          echo "Container logs (last 20 lines):"
          docker-compose logs --tail=20 backend
          
          # Verify permissions after container start
          echo "Checking uploads directory permissions:"
          docker-compose exec -T backend ls -ld /app/wwwroot/uploads || echo "Cannot check permissions inside container"
          
          # Verify Telegram configuration
          echo "Checking Telegram configuration..."
          docker-compose logs backend | grep -i "telegram\|channel" | tail -10 || echo "No Telegram logs found"
          if docker-compose exec -T backend env | grep -q "TelegramBot__ChannelId="; then
            echo "✅ Telegram ChannelId is configured"
          else
            echo "⚠️ Warning: Telegram ChannelId might not be configured"
          fi

          # Clean up old images
          docker image prune -f

          echo "=== Deployment successful ==="
      env:
        IMAGE_NAME: ${{ env.IMAGE_NAME }}
        DEPLOY_DIR: ${{ env.DEPLOY_DIR }}

  post-deploy-test:
    needs: [deploy, test-connection]
    runs-on: ubuntu-latest
    steps:
    - name: Verify deployment
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ env.SSH_PORT }}
        script: |
          echo "=== Deployment Verification ==="
          echo "Container status:"
          docker ps -a | grep ${{ env.IMAGE_NAME }} || echo "Container not found"
          echo ""
          echo "Container logs (last 50 lines):"
          docker logs --tail 50 ${{ env.IMAGE_NAME }} || echo "Could not retrieve logs"
          echo ""
          echo "Checking API health..."
          sleep 5
          curl -f http://localhost:${{ env.HOST_PORT }}/api/products || echo "API health check failed"
          echo ""
          echo "Uploads directory:"
          cd ${{ env.DEPLOY_DIR }}
          docker-compose exec -T backend ls -la /app/wwwroot/uploads/ || docker exec ${{ env.IMAGE_NAME }} ls -la /app/wwwroot/uploads/ || echo "Could not list uploads"
          echo ""
          echo "Checking Telegram token configuration:"
          if docker-compose exec -T backend env | grep -q "TelegramBot__Token="; then
            echo "✅ Telegram token is configured"
            docker-compose exec -T backend env | grep "TelegramBot__Token" | sed 's/TelegramBot__Token=.*/TelegramBot__Token=***HIDDEN***/'
          else
            echo "⚠️ Warning: Telegram token might not be configured"
          fi
          echo ""
          echo "Checking Telegram ChannelId configuration:"
          if docker-compose exec -T backend env | grep -q "TelegramBot__ChannelId="; then
            echo "✅ Telegram ChannelId is configured"
            docker-compose exec -T backend env | grep "TelegramBot__ChannelId"
          else
            echo "⚠️ Warning: Telegram ChannelId might not be configured"
          fi
          echo ""
          echo "Checking .env file:"
          if [ -f .env ] && grep -q "TELEGRAM_BOT_TOKEN=" .env && grep -q "DB_CONNECTION_STRING=" .env && grep -q "TELEGRAM_BOT_CHANNEL_ID=" .env; then
            echo "✅ .env file is properly configured with all required variables"
          else
            echo "⚠️ Warning: .env file might be missing or incomplete"
            if [ -f .env ]; then
              echo "Contents of .env (masked):"
              cat .env | sed 's/\(TELEGRAM_BOT_TOKEN=\).*/\1***/' | sed 's/\(DB_CONNECTION_STRING=.*Password=\).*\(;.*\)/\1***\2/'
            fi
          fi
          echo "=== Verification completed ==="
