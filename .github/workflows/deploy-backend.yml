name: Deploy Backend API

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      run: |
        docker build -t bebochka-backend:latest .
        
    - name: Save Docker image
      run: |
        mkdir -p /tmp/docker-images
        docker save bebochka-backend:latest | gzip > /tmp/docker-images/bebochka-backend.tar.gz
        echo "Docker image saved to /tmp/docker-images/bebochka-backend.tar.gz"
        ls -lh /tmp/docker-images/
        
    - name: Create .env file
      run: |
        cat > .env << EOF
        DB_CONNECTION_STRING=${{ secrets.DB_CONNECTION_STRING }}
        TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_BOT_CHANNEL_ID=${{ secrets.TELEGRAM_BOT_CHANNEL_ID }}
        EOF
        echo ".env file created"
        cat .env | sed 's/\(TELEGRAM_BOT_TOKEN=\).*/\1***/' | sed 's/\(DB_CONNECTION_STRING=.*Password=\).*\(;.*\)/\1***\2/'
        
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        source: "docker-compose.yml,Dockerfile,.env"
        target: "/root/bebochka-backend"
        strip_components: 0
        
    - name: Copy Docker image to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        source: "/tmp/docker-images/bebochka-backend.tar.gz"
        target: "/tmp"
        strip_components: 0
        
    - name: Load Docker image and deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          cd /root/bebochka-backend
          
          # Load Docker image
          echo "Loading Docker image..."
          docker load < /tmp/bebochka-backend.tar.gz
          
          # Create wwwroot/uploads directory if it doesn't exist
          mkdir -p wwwroot/uploads
          
          # Stop and remove old containers
          echo "Stopping old containers..."
          docker-compose down || true
          
          # Start new containers
          echo "Starting new containers..."
          docker-compose up -d
          
          # Wait for container to start
          sleep 5
          
          # Verify deployment
          echo "Verifying deployment..."
          docker-compose ps
          
          # Check if container is running
          if docker ps | grep -q bebochka-backend; then
            echo "✅ Deployment successful!"
            echo "Container is running"
          else
            echo "❌ Deployment failed!"
            echo "Container is not running"
            docker-compose logs backend
            exit 1
          fi
          
          # Check logs for errors
          echo "Checking logs..."
          docker-compose logs --tail=50 backend | grep -i "error\|exception\|failed" || echo "No errors found in logs"
          
          # Verify Telegram configuration
          echo "Checking Telegram configuration..."
          docker-compose logs backend | grep -i "telegram\|channel" | tail -5 || echo "No Telegram logs found"
