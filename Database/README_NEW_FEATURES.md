# Новые возможности: Отложенная публикация товаров и уведомления в Telegram

## Обзор

Добавлена поддержка отложенной публикации товаров с автоматическими уведомлениями в Telegram бот при наступлении даты публикации.

## Обновления базы данных

### 1. Добавление поля TelegramUserId в таблицу Users

Выполните SQL скрипт для добавления поля TelegramUserId:

```bash
mysql -u root -p bebochka < backend/Bebochka.Api/Database/fix_telegram_user_id.sql
```

Или через SSH:

```bash
ssh username@89.104.67.36
mysql -u root -p bebochka < /path/to/fix_telegram_user_id.sql
```

### 2. Добавление поля PublishedAt в таблицу Products

Выполните SQL скрипт для добавления поля PublishedAt:

```bash
mysql -u root -p bebochka < backend/Bebochka.Api/Database/add_published_at_column.sql
```

Или через SSH:

```bash
ssh username@89.104.67.36
mysql -u root -p bebochka < /path/to/add_published_at_column.sql
```

## Конфигурация

### Настройка Telegram Bot Token

Добавьте токен Telegram бота в `appsettings.json` или `appsettings.Development.json`:

```json
{
  "TelegramBot": {
    "Token": "YOUR_TELEGRAM_BOT_TOKEN_HERE"
  }
}
```

**Важно:** Токен должен быть таким же, как в Telegram Bot проекте, чтобы бот мог отправлять сообщения.

## Функциональность

### 1. Отложенная публикация товаров

- При создании или редактировании товара администратор может указать дату и время публикации
- Если дата не указана, товар публикуется немедленно
- Товары с будущей датой публикации не отображаются в каталоге до наступления указанной даты

### 2. Автоматические уведомления

- Фоновый сервис `ProductPublicationService` проверяет каждую минуту наличие товаров, готовых к публикации
- При обнаружении товаров, опубликованных в последнюю минуту, отправляется уведомление всем пользователям Telegram бота
- Текст уведомления: "Уважаемые дамы, каталог был обновлен. Успевайте забронировать товар!"

### 3. API для отправки сообщений

Добавлены новые endpoints для работы с Telegram:

- `POST /api/telegram/broadcast` - Отправка сообщения всем пользователям бота (требует авторизации)
- `POST /api/telegram/send/{chatId}` - Отправка сообщения конкретному пользователю (требует авторизации)

## Использование

### В админ-панели

1. При создании или редактировании товара заполните поле "Дата и время публикации"
2. Оставьте поле пустым для немедленной публикации
3. Укажите будущую дату и время для отложенной публикации

### Программный доступ

Пример запроса для создания товара с отложенной публикацией:

```json
POST /api/products
{
  "name": "Новый товар",
  "price": 1500,
  "publishedAt": "2024-12-25T10:00:00Z",
  ...
}
```

Пример отправки broadcast сообщения:

```json
POST /api/telegram/broadcast
{
  "message": "Ваше сообщение здесь"
}
```

## Технические детали

### Фоновые сервисы

- `ProductPublicationService` - проверяет готовность товаров к публикации каждую минуту
- Использует временное окно в 1 минуту для избежания дублирования уведомлений

### Фильтрация товаров

- `GetAllProductsAsync` и `GetProductByIdAsync` автоматически фильтруют товары по `PublishedAt`
- Отображаются только товары с `PublishedAt == null` или `PublishedAt <= текущее время`

### Telegram интеграция

- Использует Telegram Bot API напрямую
- Получает список пользователей из таблицы `Users` по полю `TelegramUserId`
- Для private чатов Chat ID равен User ID

## Примечания

- Убедитесь, что токен Telegram бота настроен правильно
- Пользователи должны иметь поле `TelegramUserId` в таблице `Users` для получения уведомлений
- Фоновый сервис запускается автоматически при старте приложения
- Уведомления отправляются только один раз при публикации товара
