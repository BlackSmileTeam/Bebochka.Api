# Инструкция по настройке MVC приложения Bebochka.Web

## Шаг 1: Обновление базы данных

Выполните SQL скрипт для добавления необходимых полей:

```bash
mysql -u root -p bebochka < backend/Bebochka.Api/Database/add_admin_and_order_statuses.sql
```

Или через MySQL клиент:

```sql
USE bebochka;
SOURCE backend/Bebochka.Api/Database/add_admin_and_order_statuses.sql;
```

## Шаг 2: Назначение администратора

Назначьте пользователя администратором. Найдите ID пользователя в таблице Users:

```sql
SELECT Id, Username, Email, IsAdmin FROM Users;
```

Затем назначьте администратора:

```sql
UPDATE Users SET IsAdmin = 1 WHERE Id = 1; -- Замените 1 на ID нужного пользователя
```

## Шаг 3: Проверка статусов заказов

Убедитесь, что существующие заказы имеют правильные статусы. Скрипт автоматически конвертирует старые статусы в новые:

- `pending` → `В сборке`
- `confirmed` → `Ожидает оплату`
- `shipped` → `В пути`
- `completed` → `Доставлен`
- `cancelled` → `Отменен`

## Шаг 4: Запуск приложения

```bash
cd Bebochka.Web
dotnet restore
dotnet run
```

## Важные замечания

1. **Автоматическое определение роли**: Интерфейс автоматически переключается между пользовательским и административным в зависимости от значения `IsAdmin` в таблице `Users`.

2. **Статусы заказов**: Новые заказы создаются со статусом "В сборке". Администратор может изменять статусы через панель управления.

3. **Отмена заказов**: При отмене заказа товары автоматически возвращаются на склад.

4. **Резервирование**: Товары в корзине резервируются на 20 минут. После этого резерв снимается автоматически.

5. **Фильтрация товаров**: В каталоге отображаются только товары с `AvailableQuantity > 0`.

## Структура базы данных

### Новые поля в таблице Users:
- `IsAdmin` (TINYINT(1)) - Флаг администратора (0 - пользователь, 1 - администратор)

### Новые поля в таблице Orders:
- `UserId` (INT) - ID пользователя, создавшего заказ
- `CancelledAt` (DATETIME) - Дата и время отмены заказа
- `CancellationReason` (VARCHAR(500)) - Причина отмены заказа

### Обновленное поле:
- `Status` - Теперь использует значения: "В сборке", "Ожидает оплату", "В пути", "Доставлен", "Отменен"

