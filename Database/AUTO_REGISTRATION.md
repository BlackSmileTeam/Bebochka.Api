# Автоматическая регистрация пользователей Telegram

## Описание

Система автоматически регистрирует всех пользователей, которые взаимодействуют с Telegram ботом, для получения уведомлений о публикации новых товаров.

## Как это работает

1. **При взаимодействии с ботом:**
   - Когда пользователь отправляет сообщение боту или нажимает на кнопку
   - Telegram бот автоматически вызывает API endpoint `/api/Telegram/register/{telegramUserId}`
   - Пользователь регистрируется в базе данных

2. **Процесс регистрации:**
   - Проверяется, существует ли пользователь с таким Telegram User ID
   - Если пользователь уже существует - активируется (IsActive = true)
   - Если пользователь не существует - создается новая запись в таблице Users

3. **Уведомления:**
   - При публикации нового товара уведомления отправляются всем активным пользователям с TelegramUserId
   - Не нужно вручную добавлять каждого пользователя

## Технические детали

### API Endpoint

```
POST /api/Telegram/register/{telegramUserId}
Authorization: не требуется (публичный endpoint)
```

### Пример запроса

```bash
POST http://your-api/api/Telegram/register/123456789
```

### Ответ

```json
{
  "message": "Telegram User ID registered successfully",
  "registered": true
}
```

### Структура данных

В таблице `Users` создаются записи с:
- `Username`: `telegram_{telegramUserId}_{timestamp}` (уникальное имя)
- `PasswordHash`: случайный хеш (не используется для входа)
- `TelegramUserId`: ID пользователя из Telegram
- `IsActive`: `true`
- `IsAdmin`: `false`

### Важные замечания

1. **Уникальность Telegram User ID:**
   - Один Telegram User ID может быть привязан только к одному пользователю
   - Если пользователь уже существует с таким TelegramUserId, он просто активируется

2. **Существующие администраторы:**
   - Если администратор уже имеет TelegramUserId, он автоматически получает уведомления
   - Не требуется дополнительная регистрация

3. **Автоматическая активация:**
   - При каждом взаимодействии с ботом пользователь автоматически активируется
   - Неактивные пользователи автоматически активируются при следующем взаимодействии

## Отключение пользователя от уведомлений

Чтобы отключить пользователя от уведомлений:

```sql
UPDATE Users SET IsActive = false WHERE TelegramUserId = YOUR_TELEGRAM_USER_ID;
```

Или через API (требуется авторизация):

```bash
PUT /api/users/{userId}
Authorization: Bearer YOUR_TOKEN
Content-Type: application/json

{
  "isActive": false
}
```

## Проверка зарегистрированных пользователей

```sql
SELECT Id, Username, TelegramUserId, IsActive, IsAdmin, CreatedAt 
FROM Users 
WHERE TelegramUserId IS NOT NULL;
```

## Troubleshooting

**Проблема:** Пользователь взаимодействует с ботом, но не получает уведомления

**Решение:**
1. Проверьте, что пользователь зарегистрирован:
   ```sql
   SELECT * FROM Users WHERE TelegramUserId = YOUR_TELEGRAM_USER_ID;
   ```

2. Убедитесь, что пользователь активен (`IsActive = true`)

3. Проверьте логи бота на наличие ошибок регистрации

4. Убедитесь, что токен Telegram бота правильно настроен

**Проблема:** Дублирование записей

**Решение:**
- Система автоматически проверяет существование пользователя перед созданием
- Если возникают дубликаты, проверьте уникальность индекса `TelegramUserId`

